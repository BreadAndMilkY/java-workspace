# RAG

RAG (Retrieval-Augmented Generation) æ˜¯ä¸€ç§ç»“åˆæ£€ç´¢å’Œç”Ÿæˆçš„æŠ€æœ¯æ¶æ„ï¼Œä¸»è¦ç”¨äºå¢å¼ºå¤§è¯­è¨€æ¨¡å‹çš„èƒ½åŠ›ã€‚
ç®€å•æ¥è¯´ï¼Œå®ƒé€šè¿‡å¼•å…¥ä¸€ä¸ªâ€œå¤–æ¥çŸ¥è¯†åº“â€ï¼Œè®©æ¨¡å‹åœ¨å›ç­”é—®é¢˜å‰å…ˆæŸ¥é˜…æƒå¨ã€æœ€æ–°çš„èµ„æ–™ï¼Œä»è€Œç”Ÿæˆæ›´å‡†ç¡®ã€æ›´æœ‰ä¾æ®çš„ç­”æ¡ˆã€‚

### ä¸€ã€ğŸ”„RAGçš„å·¥ä½œæµç¨‹

![](./images/20-RAG_1759855374289.png)

```mermaid
flowchart TD
    A[ç”¨æˆ·æé—®] --> B[æ£€ç´¢<br>Retrieval]
    B --> C[å¢å¼º<br>Augmentation]
    C --> D[ç”Ÿæˆ<br>Generation]
    D --> E[æœ€ç»ˆç­”æ¡ˆ]
    
    subgraph BDetail [æ£€ç´¢ç»†èŠ‚]
        B1[åŸå§‹çŸ¥è¯†åº“<br>æ–‡æ¡£/æ•°æ®åº“/ç½‘é¡µ] --> B2[æ–‡æœ¬åˆ‡ç‰‡<br>ä¸å‘é‡åŒ–]
    end
    
    B2 -- æ„å»ºç´¢å¼• --> F[å‘é‡æ•°æ®åº“]
    A -- å‘é‡åŒ–æŸ¥è¯¢ --> B
    B -- ç›¸ä¼¼æ€§æœç´¢<br>ä»å‘é‡åº“è·å–ç›¸å…³ç‰‡æ®µ --> F
    
    subgraph CDetail [å¢å¼ºä¸ç”Ÿæˆç»†èŠ‚]
        C1[ç»„åˆæŸ¥è¯¢ä¸æ£€ç´¢ç»“æœ] --> D1[å¤§è¯­è¨€æ¨¡å‹<br>LLM]
    end
    
    B -- ä¼ é€’æ£€ç´¢ç»“æœ --> C
    C --> C1
    D1 --> E
```

1. æ£€ç´¢ï¼šå½“ç”¨æˆ·æå‡ºä¸€ä¸ªé—®é¢˜æ—¶ï¼Œç³»ç»Ÿé¦–å…ˆå°†é—®é¢˜è½¬åŒ–ä¸ºå‘é‡ï¼ˆä¸€ç§æ•°å­¦è¡¨ç¤ºï¼‰ï¼Œç„¶ååœ¨ä¸€ä¸ªé¢„å…ˆæ„å»ºå¥½çš„å‘é‡æ•°æ®åº“ä¸­è¿›è¡Œç›¸ä¼¼æ€§æœç´¢ï¼Œæ‰¾å‡ºä¸é—®é¢˜æœ€ç›¸å…³çš„ä¿¡æ¯ç‰‡æ®µ
   ã€‚è¿™ä¸ªæ•°æ®åº“å­˜å‚¨äº†å¤–éƒ¨çŸ¥è¯†ï¼ˆå¦‚ä¼ä¸šæ–‡æ¡£ã€æœ€æ–°æ–°é—»ç­‰ï¼‰ç»è¿‡å¤„ç†åçš„å‘é‡ã€‚
2. å¢å¼ºï¼šå°†æ£€ç´¢åˆ°çš„ç›¸å…³ä¿¡æ¯ç‰‡æ®µä¸ç”¨æˆ·çš„åŸå§‹é—®é¢˜ç»„åˆåœ¨ä¸€èµ·ï¼Œå½¢æˆä¸€ä¸ªå†…å®¹ä¸°å¯Œã€ä¸Šä¸‹æ–‡æ¸…æ™°çš„â€œå¢å¼ºç‰ˆâ€æç¤ºè¯
   ã€‚ä¾‹å¦‚ï¼šâ€œè¯·æ ¹æ®ä»¥ä¸‹èµ„æ–™ï¼š{æ£€ç´¢åˆ°çš„ä¿¡æ¯}ï¼Œæ¥å›ç­”è¿™ä¸ªé—®é¢˜ï¼š{ç”¨æˆ·åŸé—®é¢˜}ã€‚â€
3. ç”Ÿæˆï¼šå°†è¿™ä¸ªå¢å¼ºåçš„æç¤ºè¯è¾“å…¥ç»™å¤§è¯­è¨€æ¨¡å‹ã€‚æ¨¡å‹ä¼šåŸºäºä½ æä¾›çš„å…·ä½“èµ„æ–™æ¥ç”Ÿæˆç­”æ¡ˆï¼Œè€Œä¸æ˜¯ä»…ä¾èµ–å…¶å†…éƒ¨è®°å¿† ã€‚

### äºŒã€ğŸ’¡RAGçš„å…¸å‹åº”ç”¨åœºæ™¯

- æ™ºèƒ½å®¢æœä¸é—®ç­”ç³»ç»Ÿï¼šä¸ºä¼ä¸šæä¾›èƒ½å‡†ç¡®å›ç­”å…³äºäº§å“ã€æ”¿ç­–ç­‰é—®é¢˜çš„å®¢æœæœºå™¨äººï¼ŒçŸ¥è¯†åº“å¯éšæ—¶æ›´æ–°ã€‚
- ä¼ä¸šçŸ¥è¯†ç®¡ç†ï¼šæ„å»ºä¼ä¸šä¸“å±çŸ¥è¯†ä¸­æ¢ï¼Œå‘˜å·¥å¯ç”¨è‡ªç„¶è¯­è¨€æŸ¥è¯¢å…¬å¸åˆ¶åº¦ã€é¡¹ç›®æ–‡æ¡£ç­‰ï¼Œå¿«é€Ÿè·å–æ‰€éœ€ä¿¡æ¯ã€‚
- ä¸“ä¸šé¢†åŸŸå’¨è¯¢ï¼šåœ¨åŒ»ç–—ã€æ³•å¾‹ã€é‡‘èç­‰é¢†åŸŸï¼Œç»“åˆæœ€æ–°çš„ä¸“ä¸šæ–‡çŒ®ã€æ³•è§„æ¡æ–‡ï¼Œä¸ºä¸“ä¸šäººå£«æä¾›è¾…åŠ©å†³ç­–æ”¯æŒï¼ŒåŒæ—¶ç¡®ä¿ç­”æ¡ˆæœ‰æ®å¯æŸ¥ã€‚
- å†…å®¹åˆ›ä½œä¸ç ”ç©¶è¾…åŠ©ï¼šå¸®åŠ©ä½œè€…æˆ–ç ”ç©¶äººå‘˜å¿«é€Ÿä»æµ·é‡èµ„æ–™ä¸­æŸ¥æ‰¾ç›¸å…³ä¿¡æ¯ï¼Œç”Ÿæˆå†…å®¹ç¿”å®çš„æŠ¥å‘Šæˆ–æ–‡ç« è‰ç¨¿ã€‚

---

### ä¸‰ã€åµŒå…¥æ¨¡å‹ (Embedding Model)

åµŒå…¥(Embedding)çš„å·¥ä½œåŸç†æ˜¯å°†æ–‡æœ¬ã€å›¾åƒå’Œè§†é¢‘è½¬æ¢ä¸ºç§°ä¸ºå‘é‡ï¼ˆVectorsï¼‰çš„æµ®ç‚¹æ•°æ•°ç»„ã€‚
è¿™äº›å‘é‡æ—¨åœ¨æ•æ‰æ–‡æœ¬ã€å›¾åƒå’Œè§†é¢‘çš„å«ä¹‰ã€‚åµŒå…¥æ•°ç»„çš„é•¿åº¦ç§°ä¸ºå‘é‡çš„ç»´åº¦ï¼ˆDimensionalityï¼‰ã€‚
åµŒå…¥æ¨¡å‹ï¼ˆEmbeddingModelï¼‰æ˜¯åµŒå…¥è¿‡ç¨‹ä¸­é‡‡ç”¨çš„æ¨¡å‹ã€‚

#### æ–‡æœ¬å‘é‡åŒ– æ¡ˆä¾‹

éœ€æ±‚ï¼šé€šè¿‡æ–‡æœ¬å‘é‡åŒ–æ¨¡å‹ï¼Œå°†è¾“å…¥çš„æ–‡æœ¬è½¬æ¢ä¸ºå‘é‡ã€‚

[application-ai-rag.yml](../01-quick-start/src/main/resources/application-ai-rag.yml)

```yaml
spring:
  ai:
    dashscope:
      embedding:
        options:
          model: text-embedding-v4
          dimensions: 64 # value shold be in [64, 128, 256, 512, 768, 1024, 1536, 2048, 3072]
```

```java
import com.alibaba.cloud.ai.dashscope.embedding.DashScopeEmbeddingModel;
import org.springframework.ai.embedding.EmbeddingModel;
import org.springframework.ai.embedding.EmbeddingResponse;

@RestController
@RequestMapping("/rag")
@Tag(name = "18-RAG")
public class _18_RagController {
    private EmbeddingModel embeddingModel;

    public _18_RagController(DashScopeChatModel dashScopeChatModel,
                             DashScopeEmbeddingModel dashScopeEmbeddingModel) {
        embeddingModel = dashScopeEmbeddingModel;
    }

    /**
     * http://localhost:888/rag/embedding?msg=ä½ å¥½
     */
    @GetMapping("/embedding")
    public Object embedding(@RequestParam String msg) {
        EmbeddingResponse embeddingResponse = this.embeddingModel.embedForResponse(List.of(msg));
        return Map.of("embedding", embeddingResponse);
    }
}
```

æ•ˆæœï¼š
![](./images/20-RAG_1760001912796.png)

### å››ã€å‘é‡æ•°æ®åº“

å‘é‡æ•°æ®åº“æ˜¯ä¸“é—¨ç”¨äºé«˜æ•ˆå­˜å‚¨ã€ç´¢å¼•å’ŒæŸ¥è¯¢å‘é‡æ•°æ®çš„æ–°å‹æ•°æ®åº“ç³»ç»Ÿï¼Œå®ƒé€šè¿‡ç›¸ä¼¼æ€§æœç´¢æ¥å¤„ç†éç»“æ„åŒ–æ•°æ®ï¼ˆå¦‚æ–‡æœ¬ã€å›¾åƒã€éŸ³é¢‘ï¼‰ï¼Œæ˜¯äººå·¥æ™ºèƒ½æ—¶ä»£çš„æ ¸å¿ƒåŸºç¡€è®¾æ–½ä¹‹ä¸€ã€‚

å‘é‡æ•°æ®åº“ä¸ä¼ ç»Ÿå…³ç³»å‹æ•°æ®åº“çš„ä¸»è¦åŒºåˆ«ï¼š

| å¯¹æ¯”ç»´åº¦    | ä¼ ç»Ÿå…³ç³»å‹æ•°æ®åº“ (å¦‚ MySQL)       | å‘é‡æ•°æ®åº“ (å¦‚ Milvus, Pinecone)        |
|:--------|:-------------------------|:----------------------------------|
| æ ¸å¿ƒæ•°æ®ç±»å‹  | ç»“æ„åŒ–çš„è¡¨æ ¼ã€è¡Œã€åˆ—               | é«˜ç»´å‘é‡ï¼ˆç”±AIæ¨¡å‹ç”Ÿæˆçš„æ•°å­—æ•°ç»„ï¼‰                |
| æ ¸å¿ƒæŸ¥è¯¢æ–¹å¼  | ç²¾ç¡®åŒ¹é…æŸ¥è¯¢ï¼ˆä½¿ç”¨SQLï¼Œå¦‚ `=`ï¼Œ `>`ï¼‰ | ç›¸ä¼¼æ€§æœç´¢ï¼ˆåŸºäºä½™å¼¦ç›¸ä¼¼åº¦ã€æ¬§æ°è·ç¦»ç­‰ï¼‰              |
| æ“…é•¿å¤„ç†çš„æ•°æ® | è®¢å•ä¿¡æ¯ã€ç”¨æˆ·èµ„æ–™ç­‰è§„æ•´çš„ç»“æ„åŒ–æ•°æ®       | æ–‡æœ¬ã€å›¾ç‰‡ã€è§†é¢‘ã€éŸ³é¢‘ç­‰éç»“æ„åŒ–æ•°æ®                |
| ç´¢å¼•æœºåˆ¶    | Bæ ‘ã€å“ˆå¸Œç´¢å¼•ç­‰ï¼Œç”¨äºå¿«é€Ÿç²¾ç¡®æŸ¥æ‰¾        | HNSWã€IVF-PQç­‰è¿‘ä¼¼æœ€è¿‘é‚»(ANN)ç®—æ³•ï¼Œç”¨äºå¿«é€Ÿç›¸ä¼¼åŒ¹é… |
| å…¸å‹åº”ç”¨åœºæ™¯  | äº¤æ˜“ç³»ç»Ÿã€è´¢åŠ¡ç®¡ç†ç³»ç»Ÿã€CRM/ERP      | æ¨èç³»ç»Ÿã€è¯­ä¹‰æœç´¢ã€å›¾åƒæ£€ç´¢ã€å¤§æ¨¡å‹çŸ¥è¯†åº“             |

#### 1ã€ğŸ”„å·¥ä½œåŸç†ç®€ä»‹

å‘é‡æ•°æ®åº“çš„å·¥ä½œæµç¨‹é€šå¸¸åŒ…å«ä¸‰ä¸ªå…³é”®æ­¥éª¤ï¼Œè¿™ä½¿å…¶ç‰¹åˆ«é€‚åˆå¤„ç†éç»“æ„åŒ–æ•°æ®ï¼š

1. å‘é‡åŒ–ï¼ˆEmbeddingï¼‰ï¼šé¦–å…ˆï¼Œåˆ©ç”¨åµŒå…¥æ¨¡å‹ï¼ˆå¦‚BERTç”¨äºæ–‡æœ¬ï¼ŒResNetç”¨äºå›¾åƒï¼‰å°†æ–‡æœ¬ã€å›¾åƒç­‰éç»“æ„åŒ–æ•°æ®è½¬æ¢ä¸ºè®¡ç®—æœºå¯ç†è§£çš„é«˜ç»´å‘é‡ï¼ˆé€šå¸¸ç”±æ•°ç™¾åˆ°æ•°åƒä¸ªæ•°å­—ç»„æˆçš„æ•°ç»„ï¼‰ ã€‚è¿™ä¸€è¿‡ç¨‹æ•æ‰äº†æ•°æ®æ·±å¤„çš„è¯­ä¹‰ç‰¹å¾ï¼Œä¾‹å¦‚ï¼Œè¯­ä¹‰ç›¸è¿‘çš„è¯æ±‡åœ¨å‘é‡ç©ºé—´ä¸­çš„ä½ç½®ä¹Ÿä¼šå¾ˆæ¥è¿‘ã€‚
2. ç´¢å¼•ä¸å­˜å‚¨ï¼šç”Ÿæˆçš„å‘é‡è¢«å­˜å…¥å‘é‡æ•°æ®åº“ï¼Œå¹¶ä¼šå»ºç«‹ä¸“é—¨çš„ç´¢å¼•ï¼ˆå¦‚HNSWã€IVF-PQï¼‰ã€‚å»ºç«‹ç´¢å¼•çš„ç›®çš„æ˜¯ä¸ºäº†å¯¹æµ·é‡é«˜ç»´å‘é‡è¿›è¡Œé«˜æ•ˆç»„ç»‡ï¼Œä»è€Œæå¤§åŠ é€Ÿåç»­çš„ç›¸ä¼¼æ€§æœç´¢è¿‡ç¨‹ã€‚
3. ç›¸ä¼¼æ€§æœç´¢ï¼šå½“ç”¨æˆ·å‘èµ·æŸ¥è¯¢æ—¶ï¼ŒæŸ¥è¯¢å†…å®¹ï¼ˆå¦‚ä¸€æ®µæ–‡å­—ï¼‰ä¹Ÿä¼šè¢«è½¬æ¢ä¸ºæŸ¥è¯¢å‘é‡ã€‚æ•°æ®åº“éšå³åœ¨ç´¢å¼•ä¸­å¿«é€Ÿå¯»æ‰¾ä¸è¿™ä¸ªæŸ¥è¯¢å‘é‡æœ€ç›¸ä¼¼çš„Top-Kä¸ªå‘é‡ã€‚ç›¸ä¼¼æ€§é€šå¸¸é€šè¿‡ä½™å¼¦ç›¸ä¼¼åº¦æˆ–æ¬§æ°è·ç¦»ç­‰ç®—æ³•æ¥è¡¡é‡ã€‚

#### 2ã€ğŸ’¡ä¸»è¦ç‰¹ç‚¹ä¸ä¼˜åŠ¿

- é«˜æ•ˆå¤„ç†éç»“æ„åŒ–æ•°æ®ï¼šä¼ä¸šæ•°æ®ä¸­è¶…è¿‡80%éƒ½æ˜¯éç»“æ„åŒ–æ•°æ®ï¼ˆå¦‚æŠ¥å‘Šã€å›¾ç‰‡ã€è§†é¢‘ï¼‰ï¼Œå‘é‡æ•°æ®åº“ä¸ºæ­¤ç±»æ•°æ®çš„åˆ©ç”¨æä¾›äº†å…³é”®å·¥å…·ã€‚
- å¼ºå¤§çš„ç›¸ä¼¼æ€§æœç´¢èƒ½åŠ›ï¼šæ”¯æŒåŸºäºè¯­ä¹‰çš„æ¨¡ç³Šæœç´¢ï¼Œè€Œä¸ä»…æ˜¯å…³é”®è¯åŒ¹é…ã€‚ä¾‹å¦‚ï¼Œæœç´¢â€œä¼šé£çš„åŠ¨ç‰©â€ï¼Œå¯ä»¥æ‰¾åˆ°å…³äºâ€œé¸Ÿç±»â€ã€â€œæ˜†è™«â€çš„å†…å®¹ï¼Œè€Œæ— éœ€å†…å®¹ç²¾ç¡®åŒ…å«â€œä¼šé£çš„åŠ¨ç‰©â€è¿™ä¸ªè¯ã€‚
- é«˜å¯æ‰©å±•æ€§ï¼šä¸ºåº”å¯¹AIåº”ç”¨å¸¸æ¶‰åŠçš„æ•°åäº¿ç”šè‡³æ›´é«˜é‡çº§çš„å‘é‡æ•°æ®ï¼Œè®¸å¤šå‘é‡æ•°æ®åº“é‡‡ç”¨åˆ†å¸ƒå¼æ¶æ„ï¼Œå¯å®ç°æ°´å¹³æ‰©å±•ã€‚
- å¤šæ¨¡æ€æ”¯æŒï¼šèƒ½å¤Ÿç»Ÿä¸€å¤„ç†æ¥è‡ªä¸åŒæ¨¡æ€ï¼ˆå¦‚æ–‡æœ¬ã€å›¾åƒã€éŸ³é¢‘ï¼‰çš„å‘é‡ï¼Œå®ç°è·¨æ¨¡æ€æ£€ç´¢ï¼Œä¾‹å¦‚ç”¨æ–‡å­—æœç´¢å›¾ç‰‡ã€‚

#### 3ã€ğŸ¯å…¸å‹åº”ç”¨åœºæ™¯

- æ¨èç³»ç»Ÿï¼šå°†ç”¨æˆ·å’Œå•†å“ï¼ˆæˆ–å†…å®¹ï¼‰è¡¨ç¤ºä¸ºå‘é‡ï¼Œé€šè¿‡ç›¸ä¼¼æ€§è®¡ç®—ä¸ºç”¨æˆ·æ¨èå¯èƒ½æ„Ÿå…´è¶£çš„å•†å“ã€‚
- è¯­ä¹‰æœç´¢ï¼šæå‡æœç´¢ä½“éªŒï¼Œä½¿æœç´¢å¼•æ“èƒ½å¤Ÿç†è§£æŸ¥è¯¢è¯­å¥çš„æ·±å±‚å«ä¹‰ï¼Œè€Œä¸ä»…ä»…æ˜¯åŒ¹é…å…³é”®è¯ã€‚
- å›¾åƒä¸è§†é¢‘æ£€ç´¢ï¼šå®ç°ä»¥å›¾æœå›¾ã€è§†é¢‘å†…å®¹åˆ†æç­‰åŠŸèƒ½ã€‚
- æ£€ç´¢å¢å¼ºç”Ÿæˆï¼ˆRAGï¼‰ï¼šè¿™æ˜¯å½“å‰å‘é‡æ•°æ®åº“æœ€é‡è¦çš„åº”ç”¨ä¹‹ä¸€ã€‚é€šè¿‡ä¸ºå¤§å‹è¯­è¨€æ¨¡å‹æä¾›å¤–éƒ¨çŸ¥è¯†åº“ï¼Œè®©æ¨¡å‹èƒ½å¤ŸåŸºäºæœ€æ–°ã€æƒå¨çš„ä¿¡æ¯ç”Ÿæˆå›ç­”ï¼Œæœ‰æ•ˆå‡å°‘â€œå¹»è§‰â€é—®é¢˜ã€‚

#### 4ã€ğŸŒŸä¸»æµäº§å“ä¸¾ä¾‹

- Milvusï¼šå¼€æºã€åˆ†å¸ƒå¼å‘é‡æ•°æ®åº“ï¼ŒåŠŸèƒ½å…¨é¢ï¼Œé€‚åˆéœ€è¦é«˜åº¦å®šåˆ¶åŒ–çš„å¤§å‹ä¼ä¸šæˆ–ç ”ç©¶æœºæ„ã€‚
- Pineconeï¼šå…¨æ‰˜ç®¡çš„å•†ä¸šæœåŠ¡ï¼Œæ— éœ€è‡ªè¡Œç®¡ç†åŸºç¡€è®¾æ–½ï¼Œç®€å•æ˜“ç”¨ï¼Œé€‚åˆä¸­å°å‹ä¼ä¸šå¿«é€Ÿéƒ¨ç½²ã€‚
- Chromaï¼šè½»é‡çº§çš„å¼€æºåµŒå…¥å¼å‘é‡æ•°æ®åº“ï¼ŒAPIç®€å•ï¼Œéå¸¸é€‚åˆå°å‹é¡¹ç›®æˆ–åŸå‹å¼€å‘ã€‚
- SimpleVectorStoreï¼šSpring AI æ¡†æ¶ä¸­ä¸€ä¸ªåŸºäºå†…å­˜çš„è½»é‡çº§å‘é‡å­˜å‚¨å®ç°ï¼Œéå¸¸é€‚åˆç”¨äºåŸå‹å¼€å‘ã€æµ‹è¯•å’Œæ•™å­¦åœºæ™¯ã€‚

#### 5ã€ä½¿ç”¨æ¡ˆä¾‹

[_18_RagController.java](../01-quick-start/src/main/java/com/zhengqing/saa/api/_18_RagController.java)

ä½¿ç”¨`SimpleVectorStore`è½»é‡çº§å‘é‡æ•°æ®åº“æ¥å­˜å‚¨&æ£€ç´¢å‘é‡æ•°æ®ã€‚

```java
import com.alibaba.cloud.ai.dashscope.chat.DashScopeChatModel;

@RestController
@RequestMapping("/rag")
@Tag(name = "18-RAG")
public class _18_RagController {

    private VectorStore vectorStore;

    public _18_RagController(DashScopeEmbeddingModel dashScopeEmbeddingModel) {
        vectorStore = SimpleVectorStore.builder(dashScopeEmbeddingModel).build();
    }


    /**
     * http://localhost:888/rag/vectorStore?topK=3&threshold=0.1&msg=æœ‰å“ªäº›å¼€æºçš„å‘é‡æ•°æ®åº“ï¼Ÿ
     * http://localhost:888/rag/vectorStore?topK=3&threshold=0.1&msg=LangChain
     */
    @GetMapping("/vectorStore")
    public Object vectorStore(@RequestParam String msg, @RequestParam int topK, @RequestParam double threshold) {
        // åº•å±‚æš‚æœªå®ç°å…·ä½“é€»è¾‘...
//        vectorStore.delete(new Filter.Expression(Filter.ExpressionType.NOT, new Filter.Key("xx")));
        // 1ã€å­˜å‚¨å‘é‡ -- æ·»åŠ æ–‡æ¡£åˆ°å‘é‡æ•°æ®åº“
        vectorStore.add(Lists.newArrayList(
                Document.builder().text("LangChainæ˜¯ä¸€ä¸ªç”¨äºå¼€å‘ç”±è¯­è¨€æ¨¡å‹é©±åŠ¨çš„åº”ç”¨ç¨‹åºçš„æ¡†æ¶ã€‚").build(),
                Document.builder().text("Milvusæ˜¯ä¸€æ¬¾å¼€æºå‘é‡æ•°æ®åº“ï¼Œä¸“ä¸ºå¤§è§„æ¨¡å‘é‡ç›¸ä¼¼æ€§æœç´¢è€Œè®¾è®¡ã€‚").build()
        ));

        // 2ã€ç›¸ä¼¼æ€§æœç´¢ -- æ ¹æ®æŸ¥è¯¢å†…å®¹æœç´¢ç›¸ä¼¼æ–‡æ¡£
//        return vectorStore.similaritySearch("æœ‰å“ªäº›å¼€æºçš„å‘é‡æ•°æ®åº“ï¼Ÿ"); // æ‰§è¡Œæœç´¢å¹¶è¿”å›ç»“æœ
        return vectorStore.similaritySearch(SearchRequest.builder()
                .query(msg) // ç”¨æˆ·è¾“å…¥çš„æŸ¥è¯¢å†…å®¹
                .topK(topK) // è¿”å›æœ€ç›¸ä¼¼çš„å‰nä¸ªç»“æœ
                .similarityThreshold(threshold) // è®¾ç½®ç›¸ä¼¼åº¦é˜ˆå€¼ï¼Œä»…è¿”å›ç›¸ä¼¼åº¦é«˜äºxxçš„ç»“æœ
                .build());
    }

}
```

æ•ˆæœï¼š
![](./images/20-RAG_1760021655466.png)

### äº”ã€æ¥å…¥ ChatClient

#### æ–¹å¼1 -- æ‰‹åŠ¨å®ç° RAG

éœ€è¦æ‰‹åŠ¨è°ƒç”¨ vectorStore.similaritySearch è¿›è¡Œæ£€ç´¢

[_18_RagController.java](../01-quick-start/src/main/java/com/zhengqing/saa/api/_18_RagController.java)

```java
/**
 * æ¥å…¥ ChatClient
 * http://localhost:888/rag/chat?msg=iPhone15çš„æ€»è´¹ç”¨
 */
@GetMapping("/chat")
public Flux<String> chat(@RequestParam String msg) {
    // 1ã€å­˜å‚¨å•†å“è´¹ç”¨ä¿¡æ¯åˆ°å‘é‡æ•°æ®åº“
    vectorStore.add(Lists.newArrayList(
            Document.builder().text("iPhone18 åŸºç¡€ä»·æ ¼: 5999å…ƒ, ç¨ç‡: 13%, è¿è´¹: 0å…ƒ").build(),
            Document.builder().text("MacBook Pro8 åŸºç¡€ä»·æ ¼: 12999å…ƒ, ç¨ç‡: 13%, è¿è´¹: 50å…ƒ").build(),
            Document.builder().text("AirPods8 åŸºç¡€ä»·æ ¼: 1299å…ƒ, ç¨ç‡: 13%, è¿è´¹: 0å…ƒ").build()
    ));

    // 2ã€ä»å‘é‡æ•°æ®åº“ä¸­æ£€ç´¢ç›¸å…³å•†å“ä¿¡æ¯
    List<Document> relevantDocs = vectorStore.similaritySearch(
            SearchRequest.builder()
                    .query(msg)
                    .topK(3)
                    .similarityThreshold(0.5)
                    .build()
    );

    // 3ã€å°†æ£€ç´¢åˆ°çš„å•†å“ä¿¡æ¯ä½œä¸ºä¸Šä¸‹æ–‡ä¼ é€’ç»™ ChatClient
    String context = relevantDocs.stream()
            .map(Document::getText)
            .collect(Collectors.joining("\n"));

    // 4ã€ä½¿ç”¨ ChatClient ç”ŸæˆåŸºäºæ£€ç´¢ä¿¡æ¯çš„å›ç­”
    return chatClient.prompt()
            .user(msg)
            .system("è¯·åŸºäºä»¥ä¸‹å•†å“è´¹ç”¨ä¿¡æ¯è®¡ç®—æ€»è´¹ç”¨ï¼Œéœ€è¦è€ƒè™‘åŸºç¡€ä»·æ ¼ã€ç¨ç‡å’Œè¿è´¹ï¼š\n" + context + "\nè¯·ç»™å‡ºè¯¦ç»†çš„è®¡ç®—è¿‡ç¨‹å’Œæœ€ç»ˆç»“æœã€‚htmlæ ¼å¼å“åº”")
            .stream()
            .content();
}
```

æ•ˆæœï¼š
![](./images/20-RAG_1760025019818.png)

#### æ–¹å¼2 -- ä½¿ç”¨ QuestionAnswerAdvisor è‡ªåŠ¨åŒ–å¤„ç†RAGæµç¨‹

é€šè¿‡`spring-ai-advisors-vector-store`å°†å‘é‡æ£€ç´¢èƒ½åŠ›æ¥å…¥ ChatClientï¼Œæ ¸å¿ƒæ˜¯ä½¿ç”¨ QuestionAnswerAdvisorã€‚
å®ƒèƒ½è‡ªåŠ¨ä»å‘é‡åº“ä¸­æ£€ç´¢ç›¸å…³ä¿¡æ¯ï¼Œå¹¶æ•´åˆåˆ°æé—®ä¸­ï¼Œè®©å¤§æ¨¡å‹çš„å›ç­”æ›´å‡†ç¡®ã€æ›´æœ‰ä¾æ®ã€‚

[pom.xml](../01-quick-start/pom.xml)

```
<dependency>
    <groupId>org.springframework.ai</groupId>
    <artifactId>spring-ai-advisors-vector-store</artifactId>
</dependency>
```

[_18_RagController.java](../01-quick-start/src/main/java/com/zhengqing/saa/api/_18_RagController.java)

```java
/**
 * æ¥å…¥ ChatClient
 * http://localhost:888/rag/chat2?msg=iPhone18çš„æ€»è´¹ç”¨
 * http://localhost:888/rag/chat2?msg=iPhone20çš„æ€»è´¹ç”¨
 */
@GetMapping("/chat2")
public Flux<String> chat2(@RequestParam String msg) {
    // 1ã€å­˜å‚¨å•†å“è´¹ç”¨ä¿¡æ¯åˆ°å‘é‡æ•°æ®åº“
    vectorStore.add(Lists.newArrayList(
            Document.builder().text("iPhone18 åŸºç¡€ä»·æ ¼: 5999å…ƒ, ç¨ç‡: 13%, è¿è´¹: 0å…ƒ").build(),
            Document.builder().text("MacBook Pro8 åŸºç¡€ä»·æ ¼: 12999å…ƒ, ç¨ç‡: 13%, è¿è´¹: 50å…ƒ").build(),
            Document.builder().text("AirPods8 åŸºç¡€ä»·æ ¼: 1299å…ƒ, ç¨ç‡: 13%, è¿è´¹: 0å…ƒ").build()
    ));

    /**
     * 2ã€å®šä¹‰è‡ªå®šä¹‰æç¤ºæ¨¡æ¿ï¼ˆPromptTemplateï¼‰ -- ç”¨äºæŒ‡å¯¼AIæ¨¡å‹å¦‚ä½•åŸºäºæ£€ç´¢åˆ°çš„èƒŒæ™¯ä¿¡æ¯æ¥å›ç­”ç”¨æˆ·é—®é¢˜
     * å ä½ç¬¦è‡ªåŠ¨æ³¨å…¥ä¸Šä¸‹æ–‡
     * {question_answer_context}ï¼šä¼šè¢«QuestionAnswerAdvisorè‡ªåŠ¨æ›¿æ¢ä¸ºä»å‘é‡æ•°æ®åº“æ£€ç´¢åˆ°çš„ç›¸å…³æ–‡æ¡£å†…å®¹
     * {query}ï¼šä¼šè¢«ç”¨æˆ·çš„å®é™…é—®é¢˜å†…å®¹æ›¿æ¢
     */
    PromptTemplate customTemplate = PromptTemplate.builder()
            .template("""
                    è¯·ä¸¥æ ¼æ ¹æ®ä»¥ä¸‹èƒŒæ™¯ä¿¡æ¯å›ç­”é—®é¢˜ï¼Œç»™å‡ºè¯¦ç»†çš„è®¡ç®—è¿‡ç¨‹å’Œæœ€ç»ˆç»“æœï¼Œhtmlæ ¼å¼å“åº”ã€‚å¦‚æœä¿¡æ¯ä¸­æ²¡æœ‰ç­”æ¡ˆï¼Œè¯·ç›´æ¥è¯´"æˆ‘ä¸çŸ¥é“"ã€‚
                    èƒŒæ™¯ä¿¡æ¯ï¼š
                    {question_answer_context}
                    ç”¨æˆ·é—®é¢˜ï¼š{query}
                    """)
            .build();

    // 3ã€ä½¿ç”¨ ChatClient é…åˆ QuestionAnswerAdvisor è‡ªåŠ¨ç”Ÿæˆå›ç­”
    return chatClient.prompt()
            .user(msg)
            .advisors(
                    // æ—¥å¿—è°ƒè¯•
                    SimpleLoggerAdvisor.builder().build(),
                    // æ¥å…¥RAGèƒ½åŠ› - ä½¿ç”¨ QuestionAnswerAdvisor è‡ªåŠ¨å¤„ç†å‘é‡æ£€ç´¢
                    QuestionAnswerAdvisor.builder(vectorStore)
                            .promptTemplate(customTemplate)
                            .searchRequest(
                                    SearchRequest.builder()
                                            .topK(3)
                                            .similarityThreshold(0.65)
                                            .build()
                            ).build()
            )
            .stream()
            .content();
}
```

æ•ˆæœï¼š
![](./images/20-RAG_1760027039032.png)
